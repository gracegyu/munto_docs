# .env 관리 방법 보고서 — GitHub Actions + CodePipeline 운영 가이드

# 1. 개요

`.env` 파일은 애플리케이션 실행 시 필요한 환경 변수를 정의합니다. 본 문서는 **GitHub Actions가 주 CI/CD 파이프라인**이고, **프로덕션 CDK 배포만 AWS CodePipeline**을 사용하는 조직 환경을 기준으로, `.env`/시크릿을 안전하고 재현성 있게 운영하는 표준안을 제시합니다.

---

## 2. 관리 원칙

1. **비밀은 절대 Git에 커밋하지 않는다.** `.env`, `.env.*`, `.env.local`은 모두 `.gitignore` 처리.
2. **단일 출처(Single Source of Truth)는 AWS SSM Parameter Store/Secrets Manager.**
3. **환경별 분리**: `/myapp/{env}/{KEY}` 네이밍(`dev/test/prod`) 고정. 레포에는 `.env.example`/`.env.dev.sample`만 제공.
4. **로컬 개발 편의성**: 개인 PC 차이는 \**`.env.local`*로 오버라이드(절대 커밋 금지).
5. **런타임 주입 우선**: CI/CD에서 **환경변수로 직접 주입**(가능하면 `.env` 파일 생성 지양). 이미지/아티팩트에 비밀 포함 금지.
6. **검증/가드레일**: `dotenv-safe`/`envalid` 스키마 검증, 비밀 스캐닝, 최소권한 IAM, 로테이션/감사.

---

## 3. CI/CD 토폴로지(표준)

- **GitHub Actions(CI/CD 기본)**
  - 브랜치 전략 예: `feature/*` → PR → `dev`/`main` 머지 → 자동 빌드/테스트/배포(dev/test).
  - AWS 접근은 **GitHub OIDC + AssumeRole** 권장(장기 키 미사용).
  - Parameter Store에서 값을 읽어 **환경변수로 export** 후 빌드/배포.
- **AWS CodePipeline(Prod CDK 전용)**
  - 트리거: 릴리스 태그(`v*`) 또는 `main` 보호 브랜치.
  - Stages: Source(코드) → Build(CodeBuild: `cdk synth`) → Deploy(`cdk deploy`).
  - CodeBuild에서 Parameter Store 읽기 → CDK 컨텍스트/환경변수로 주입.

---

## 4. 레포지토리/파일 구조

```
.gitignore             # .env, .env.* 및 .env.local 무시
.env.example           # 키/형식 템플릿 (값 없음/dummy)
.env.dev.sample        # 로컬 샘플(민감값 없음)
.env.local             # 개인 환경 오버라이드(커밋 금지)
config/public.env      # 공개 가능한 비민감 기본값(옵션)
.dockerignore          # 반드시 .env, .env.* 포함
```

**.gitignore 예시**

```
.env
.env.*
!.env.example
!.env.dev.sample
.env.local
```

**.dockerignore 예시**

```
.env
.env.*
```

---

## 5. 개발자 간 공유 & 변경 전파

### 5.1 초기 온보딩

1. 개발자는 `.env.dev.sample`을 복사해 `.env` 생성. 2) 필요 값은 스크립트로 **Parameter Store 동기화**. 3) 변수 설명/타입은 Notion/Confluence에 기록(값은 기록 금지).

### 5.2 자동 동기화 스크립트(표준 커맨드)

- `npm run env:sync` 또는 `make env-sync` → 지정 프리픽스(`/myapp/dev/`)의 파라미터를 내려받아 **환경변수 export** 또는 `.env` 생성(로컬 한정).
- **페이지네이션/복호화/키 충돌 처리** 내장. (부록 A 참고)

### 5.3 변경 발생 시

1. **Parameter Store 업데이트** → 2) Slack/Teams 공지(변수명/사유, 값은 미공개) → 3) 개발자/파이프라인에서 동기화 실행 → 4) `dotenv-safe`/`envalid`로 누락 즉시 fail-fast.

---

## 6. GitHub Actions 구현 패턴

### 6.1 AWS OIDC 연동(권장)

- `aws-actions/configure-aws-credentials@v4` + `role-to-assume`로 임시 인증.
- IAM 신뢰 정책(요지): GitHub OIDC provider + `repo:ORG/REPO:*` 서브젝트 제한.

**워크플로 템플릿 예시**

```
name: CI-CD (dev)
on:
  push:
    branches: ["dev"]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write   # OIDC
      contents: read
    env:
      AWS_REGION: ap-northeast-2
      DEPLOY_ENV: dev
      SSM_PREFIX: /myapp/${{ env.DEPLOY_ENV }}/
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::123456789012:role/gha-deploy-dev
          aws-region: ${{ env.AWS_REGION }}

      - name: Export env from SSM to GitHub env
        run: |
          aws ssm get-parameters-by-path \
            --path "$SSM_PREFIX" \
            --recursive --with-decryption --output json \
          | jq -r '.Parameters[] | "export " + ( .Name | split("/") | last ) + "=\"" + .Value + "\""' \
          >> "$GITHUB_ENV"

      - name: Install deps & build
        run: |
          npm ci
          npm run build

      - name: Deploy (example)
        run: |
          npm run deploy:dev
```

> 주의: 로그에 비밀이 에코되지 않도록 set -x 금지, echo 최소화. 필요 시 서비스 코드가 .env 파일을 요구하면 빌드 디렉터리 제외 경로에 임시 생성하고 즉시 삭제.

### 6.2 환경 분리와 보호

- GitHub **Environments**(`dev/test/prod`) 활용: 보호 규칙, 승인자 요구, 시크릿 바인드.
- `concurrency` 키로 환경별 단일 실행 보장.

---

## 7. Prod CDK 배포 — CodePipeline 패턴

### 7.1 파이프라인 개요

- **Source**: GitHub(코드스타 커넥션) 또는 S3 아티팩트.
- **Build(CodeBuild)**: `cdk synth` 전 **Parameter Store 로드** 후 환경변수/컨텍스트에 주입.
- **Deploy**: `cdk deploy`(승인 단계 선택).

### 7.2 CodeBuild buildspec 예시(요지)

```
version: 0.2
phases:
  install:
    runtime-versions:
      nodejs: 18
  pre_build:
    commands:
      - export AWS_REGION=ap-northeast-2
      - export DEPLOY_ENV=prod
      - export SSM_PREFIX=/myapp/${DEPLOY_ENV}/
      - |
        aws ssm get-parameters-by-path \
          --path "$SSM_PREFIX" --recursive --with-decryption --output json \
        | jq -r '.Parameters[] | "export " + ( .Name | split("/") | last ) + "=\"" + .Value + "\""' \
        >> /tmp/env.sh
      - source /tmp/env.sh   # 이 파일은 아티팩트에 포함 금지
  build:
    commands:
      - npm ci
      - npx cdk synth
  post_build:
    commands:
      - npx cdk deploy --require-approval never
artifacts:
  files:
    - '**/*'
  discard-paths: no
```

> 권장: CodeBuild/CodePipeline 역할에 최소 권한(SSM 읽기 + KMS 복호화)만 부여. /tmp/env.sh와 같은 임시 파일은 아티팩트 제외.

### 7.3 CDK 권장사항

- 시크릿은 **`secretsmanager/ssm` 참조**(`fromSecretNameV2`, `fromStringParameterName`).
- 스택 파라미터에는 **민감값 대신 참조(ARN/이름)**만 전달.
- 필요한 리소스(Role/Lambda/ECS Task)에만 `ssm:GetParameter*`/`secretsmanager:GetSecretValue` 권한 부여.

---

## 8. 보안·거버넌스 가드레일

1. **비밀 스캐닝**: `gitleaks`/`detect-secrets` + GitHub Secret Scanning/Push Protection.
2. **pre-commit**: `.env` 커밋 차단, 민감패턴 정규식 검사.
3. **IAM 최소권한**: 경로 프리픽스 단위 리소스 제한, KMS CMK 별도 운용.
4. **로테이션**: 키/토큰 주기적 갱신, 폐기 자동화(만료 알림).
5. **감사**: CloudTrail, CodeBuild/Actions 로그, SSM Parameter 변경 이력 점검.
6. **분기 보호**: `main`/`prod` 보호 규칙 + 필수 리뷰 + 상태 체크.

---

## 9. 운영 체크리스트(요약)

-

---

## 부록 A. 로컬 동기화 스크립트(Bash)

```
#!/usr/bin/env bash
set -euo pipefail
PREFIX="${1:-/myapp/dev/}"
OUT=".env"   # 로컬에서만 사용, 커밋 금지
: > "$OUT"
NEXT=""
while :; do
  if [ -z "$NEXT" ]; then
    RESP=$(aws ssm get-parameters-by-path --path "$PREFIX" --recursive --with-decryption --output json)
  else
    RESP=$(aws ssm get-parameters-by-path --path "$PREFIX" --recursive --with-decryption --output json --next-token "$NEXT")
  fi
  echo "$RESP" | jq -r '.Parameters[] | (.Name | split("/") | last) + "=" + .Value' >> "$OUT"
  NEXT=$(echo "$RESP" | jq -r '.NextToken // empty')
  [ -z "$NEXT" ] && break
done
echo "Wrote $(wc -l < "$OUT") entries to $OUT"
```

## 부록 B. GitHub Actions IAM 신뢰 정책(발췌)

```
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {"Federated": "arn:aws:iam::123456789012:oidc-provider/token.actions.githubusercontent.com"},
      "Action": "sts:AssumeRoleWithWebIdentity",
      "Condition": {
        "StringEquals": {"token.actions.githubusercontent.com:aud": "sts.amazonaws.com"},
        "StringLike": {"token.actions.githubusercontent.com:sub": "repo:ORG/REPO:*"}
      }
    }
  ]
}
```

## 부록 C. 최소 IAM 권한(SSM/KMS)

```
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "ssm:GetParameter",
        "ssm:GetParameters",
        "ssm:GetParametersByPath",
        "ssm:DescribeParameters"
      ],
      "Resource": "arn:aws:ssm:ap-northeast-2:123456789012:parameter/myapp/*"
    },
    {
      "Effect": "Allow",
      "Action": ["kms:Decrypt"],
      "Resource": "arn:aws:kms:ap-northeast-2:123456789012:key/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
    }
  ]
}
```

## 부록 D. `.env.local` 운용 규칙

- 개인 PC 전용 오버라이드 파일. **절대 커밋/배포 금지**.
- 우선순위 예: `process.env`(런타임 주입) > `.env.local` > `.env` > 샘플/기본값.
- 값이 멀티라인인 경우 `.env` 사용은 피하고 **런타임 환경변수**로만 주입.
