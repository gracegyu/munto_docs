# Feature Gate 개요 및 구현 가이드

## 1. Feature Gate란?

Feature Gate는 **애플리케이션에 포함된 기능의 활성/비활성을 런타임에 제어할 수 있는 장치**입니다. 새로운 기능을 전체 사용자에게 한 번에 배포하지 않고, **일부 사용자에게만 점진적으로 노출**하거나, 문제가 발생했을 때 **즉시 롤백**할 수 있도록 합니다.

즉, 배포(코드 릴리스)와 노출(기능 활성화)을 분리하여, 위험을 줄이고 실험(A/B 테스트, 점진 배포)을 가능하게 하는 기술입니다.

---

## 2. 왜 필요한가?

- **위험 관리**: 새로운 기능을 전체 사용자에게 바로 적용하지 않고, 10% → 20% → 50% → 100%로 점진 확대.
- **빠른 롤백**: 문제가 생기면 앱 재배포 없이 즉시 기존 기능으로 복귀 가능.
- **실험/테스트**: 사용자 그룹을 나누어 기능 비교, 성능 및 사용자 반응 확인.
- **멀티 세그먼트 제어**: 플랫폼, 앱 버전, 국가, 테넌트별로 다른 기능 노출 가능.

---

## 3. 핵심 구성 요소

### (1) Feature Gates 테이블

| 필드         | 설명                             |
| ------------ | -------------------------------- |
| gateKey      | 게이트 이름 (예: `calendar.alt`) |
| description  | 기능 설명                        |
| defaultValue | 네트워크 실패 시 기본값          |
| salt         | 안정 버킷팅용 시드 값            |
| status       | active/paused/archived           |

### (2) Rules 테이블

| 필드           | 설명                            |
| -------------- | ------------------------------- |
| gateKey        | 연결된 Feature Gate 키          |
| ruleId         | 규칙 식별자                     |
| rolloutPercent | 적용 비율 (예: 10, 20, 50, 100) |
| segments       | 조건 (플랫폼, 국가, 앱버전 등)  |
| enabled        | 규칙 활성 여부                  |

### (3) Changelog 테이블

- 누가 언제 어떤 Feature Gate를 변경했는지 기록

---

## 4. 동작 방식

1. **클라이언트 요청**

   ```
   GET /feature-gates?env=prod&app=munto&ver=2.30.1&uidHash=abcd1234&platform=ios&country=KR

   ```

2. **서버 평가 로직**

   ```jsx
   bucket = hash(uidHash + ':' + gateKey + ':' + salt) % 100
   enabled = segmentMatch(userAttrs, rule.segments) && bucket < rolloutPercent
   ```

3. **서버 응답(JSON 예시)**

   ```json
   {
     "version": "2025-09-16T04:00:00Z",
     "ttlSec": 900,
     "gates": {
       "calendar.alt": true,
       "grid.v2": false
     },
     "etag": "W/\"abc123\""
   }
   ```

4. **클라이언트 처리 (Flutter 예시)**

   ```dart
   final useAlt = gates['calendar.alt'] ?? false;
   return useAlt ? NewCalendar() : SfCalendar();

   ```

---

## 5. 운영 패턴

- **점진적 적용**: 10% → 20% → 50% → 100%로 확대.
- **롤백**: 문제가 발생하면 rolloutPercent를 0으로 설정하거나 enabled=false로 전환.
- **세그먼트 제어**: 특정 플랫폼, 국가, 테넌트에만 기능 노출.
- **모니터링**: 에러율, 성능(FPS, 메모리), 사용자 행동 이벤트 추적.
- **부채 청산**: 기능이 안정화되면 Feature Gate와 구 코드를 제거하여 유지보수 부담 최소화.

---

## 6. Feature Gate vs. 스토어 점진 배포

### Feature Gate

- **특징**: 앱에 이미 포함된 코드/리소스의 활성화 여부를 서버에서 원격 제어.
- **장점**: 배포 없이 즉시 On/Off 가능, 특정 세그먼트나 사용자 그룹 단위 제어, 빠른 롤백.
- **적용 사례**: 새로운 UI 컴포넌트 도입, 실험(A/B 테스트), 국가별 정책 적용, 특정 기능 단계적 노출.
- **제한 사항**: 문제가 코드/리소스 자체에 있으면 게이트로 해결 불가(잘못된 리소스가 앱에 포함된 경우).

### 스토어 점진 배포 (App Store/Play Store)

- **특징**: 앱 스토어의 기능을 이용해 새 버전을 사용자에게 점진적으로 배포.
- **장점**: 코드/리소스 자체를 교체 가능, 잘못된 빌드나 버그가 포함된 경우 대응 가능.
- **적용 사례**: 크리티컬 버그 수정, 국제화 모듈 수정, 빌드 오류 해결 등.
- **제한 사항**: 심사 및 배포 지연, 롤백 속도 제한.

### 과거 국제화 사례

- 날짜 모듈에서 문제가 발생했을 때, 이는 **리소스 자체의 오류**였기 때문에 Feature Gate로는 해결이 불가능했습니다. 이 경우에는 **스토어 점진 배포가 더 적절한 대응**이었습니다.

### 병행 사용 가능성

- **혼합 전략**도 가능합니다.
  - 코드/리소스가 앱에 포함되어 있고 단순히 선택 문제라면 Feature Gate로 제어.
  - 그러나 구조적 수정이 필요한 경우 새 빌드를 점진 배포.
- 예: 새로운 날짜 포맷 로직을 앱에 미리 포함시키고, 게이트로 켜거나 끄면서 실험. 문제가 크면 스토어에서 패치 빌드를 점진 배포.

---

## 7. 100% 적용 후 처리 방법

- **Exit Criteria 확인**: 운영 지표 정상, 사용자 불편 없음, 일정 기간 문제 발생 없음.
- **코드 고정(Fix)**: 대체 구현을 기본 경로로 확정하고, Feature Gate 분기를 제거.
- **구 코드 제거**: 이전 구현(Syncfusion 등)과 불필요한 의존성 삭제.
- **Rule 정리**: 관련 Rule 삭제, Feature Gate 상태를 `archived`로 변경.
- **문서 및 로그 업데이트**: 변경 이력 기록, 운영 가이드/CHANGELOG 반영.
- **최종 청산**: 일정 보존 기간 후 BE/DB에서 Feature Gate를 물리 삭제.

---

## 8. 장점과 유의사항

### 장점

- 위험 없는 배포와 빠른 롤백 가능
- 운영자가 콘솔에서 손쉽게 퍼센트 조정 가능
- 세밀한 사용자 그룹 제어

### 유의사항

- Feature Gate와 기존 코드가 공존 → 코드 복잡성 증가
- 오래된 Feature Gate를 제거하지 않으면 기술 부채 발생
- 운영 권한, 변경 이력 관리가 중요

---

## 9. 결론

Feature Gate는 **새 기능을 안전하게 배포**하고 **문제 발생 시 즉시 대응**할 수 있는 핵심 운영 도구이며, 스토어 점진 배포는 **코드/리소스 자체가 잘못된 경우**에 반드시 필요한 전략입니다.

두 방법은 상호 배타적이지 않으며, **기능 선택/노출은 Feature Gate**, **코드/리소스 교체는 스토어 점진 배포**로 병행하는 것이 가장 현실적이고 안전한 접근입니다.
