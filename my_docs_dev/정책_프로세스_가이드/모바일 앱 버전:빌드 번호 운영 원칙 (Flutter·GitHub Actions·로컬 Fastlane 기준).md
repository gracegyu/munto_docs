# **모바일 앱 버전/빌드 번호 운영 원칙 (Flutter·GitHub Actions·로컬 Fastlane 기준)**

## 1) 목적

- iOS(TestFlight/App Store), Android(Play Console) 제출 시 **버전/빌드 번호 충돌**을 구조적으로 방지하고, 릴리스 이력을 명확히 관리한다.

## 2) 용어 정의

- **버전(Version, 마케팅 버전)**: `x.y.z` 형식. 사용자에게 노출되는 버전.
- **빌드 번호(Build Number)**: iOS `CFBundleVersion` / Android `versionCode`. **정수, 단조 증가**.
- **태그(Tag)**: Git의 릴리스 식별자(예: `v1.4.0`).

## 3) 핵심 원칙

- **원칙 1. 버전의 일관성**
  - 동일한 Git **Tag**로 재빌드하더라도 **버전(`x.y.z`)은 동일**하다.
  - 버전은 **수동으로 관리**하며, **소스코드**(예: `pubspec.yaml`)와 **Git Tag**에 **동일 값**으로 기록한다.
  - 태그와 소스의 버전이 불일치하면 **빌드를 실패**시킨다.
- **원칙 2. 빌드 번호의 자동 증가**
  - 동일한 Git **Tag**를 다시 빌드해도 **빌드 번호는 매번 증가**한다.
  - 빌드 번호는 **CI가 자동 부여**하며, **VCS(깃)에 커밋하지 않는다.**

## 4) 기대 효과

- **효과 1. 스토어 업로드 충돌 방지**
  - 동일 버전을 재제출하더라도 빌드 번호가 항상 증가하여 TestFlight/Play 콘솔의 **빌드 중복** 오류를 방지.
- **효과 2. 깔끔한 Git 이력 유지**
  - 빌드할 때마다 변경되는 **빌드 번호가 Git 커밋으로 누적되지 않음** → 이력 노이즈 제거, 리뷰/감사 용이.

## 5) 운영 지침

- **버전(Version)**
  - 변경은 **릴리스 절차(릴리스 PR/승인)**에서만 수행한다.
  - `pubspec.yaml`의 `version:` 값과 Git Tag(`vX.Y.Z-a1`)를 **항상 동기화**한다.
  - 프리릴리스 표기 권장:
    - 개발 채널: `1.4.0-dev.N`
    - 테스트 채널: `1.4.0-rc.N`
    - 운영/프로덕션: `1.4.0`
- **빌드 번호(Build Number)**
  - **GitHub Actions**: 전역 시퀀스(예: `run_number`)를 사용해 단조 증가. 브랜치/채널과 무관하게 **전역 단일 시퀀스**를 권장한다(특히 Android는 앱 전체 전역 단조 증가 필요). 빌드 번호는 **런타임 파라미터로 주입**하고, 소스 파일을 수정/커밋하지 않는다.
  - **로컬(Fastlane) 빌드**: 다음 **우선순위 규칙**으로 단조 증가를 보장한다.
    1. **스토어 조회 후 +1**
       - iOS: 동일 버전(`CFBundleShortVersionString`)에 대해 **TestFlight 최신 빌드 번호**를 조회하여 **+1**을 사용.
       - Android: 모든 트랙에서 **최대 `versionCode`**를 조회하여 **+1**을 사용.
       - 목적: 팀 전반(로컬·CI 포함)에서 **전역 단조 증가**를 유지.
    2. **네트워크/권한 불가 시 안전한 대체 규칙 적용**
       - 예: 날짜 기반(YYYYMMDDNN 등)처럼 **단조 증가가 보장되는 형식**을 사용하되, **업로드 전 스토어의 현재 값보다 큰지 검증**한다.
       - 검증 실패 시 **빌드/업로드 중단**.
    3. **원칙**
       - 빌드 번호는 **Git에 커밋하지 않는다**(이력 오염 방지).
       - 업로드 직전 **스토어 기준으로 최종 검증** 후 제출한다.
- **검증/차단(게이트)**
  - 태그 빌드 시: **태그 ↔ 소스 버전 일치** 확인. 불일치 시 **빌드 실패**.
  - 빌드 번호 정책 위반(정수 아님/감소) 시 **빌드 실패**.
  - 로컬/CI 어디서나 **제출 전 스토어의 현재 빌드 번호/버전코드보다 큰지**를 확인하고, 아니면 **중단**한다.

## 6) 브랜치·태그 정책 (참고 플로우)

- 브랜치: `main → production → test → development`
- 릴리스는 **Tag 기반**으로만 관리(annotated, 서명 권장).
- 테스트 채널은 브랜치 빌드로 운영하되, **버전은 고정**, **빌드 번호만 증가**.
- 프로덕션 릴리스는 태그 푸시로 트리거, **버전=태그=소스** 동기화.

## 7) 실패 조건(명시)

- `Tag(vX.Y.Z)`와 `pubspec.yaml`의 버전(`X.Y.Z`)이 다르면 **FAIL**.
- 빌드 번호가 이전 빌드보다 **감소/중복**되면 **FAIL**.
- 빌드 번호를 소스에 커밋하려는 시도 감지 시 **FAIL**(정책 위반).

## 8) 예외 처리

- 긴급 핫픽스에서 버전을 올리지 않고 재제출이 필요한 경우: **동일 버전 + 증가된 빌드 번호**로 재빌드/재제출.
- Android `versionCode` 상한(정수 범위) 고려하여 **번호 체계**는 장기적으로 안전한 형식을 채택.
- 로컬 빌드 중 스토어 조회 불가 시: **대체 규칙으로 생성**하되, **업로드 단계에서 스토어 기준 재검증**을 통과하지 못하면 제출을 중단한다.

## 9) 거버넌스/역할

- **릴리스 오너**: 버전 승인, 태그 발행 승인.
- **CI 담당**: 빌드 번호 정책 유지, 게이트 스크립트 관리.
- **리뷰어**: 태그/소스 버전 일치 확인 체크리스트 항목 검증.

## 10) 체크리스트(릴리스 전)

-

---

**요약**:

- **버전**은 사람이 **태그와 소스에 동일**하게 기록(불일치 시 차단).
- **빌드 번호**는 기계가 **매 빌드 자동 증가**, Git에 **커밋 금지**.
- **로컬(Fastlane)·CI(GitHub Actions) 어디서 빌드하든**, 업로드 전 **스토어 기준으로 단조 증가 검증**을 거쳐 제출한다.
