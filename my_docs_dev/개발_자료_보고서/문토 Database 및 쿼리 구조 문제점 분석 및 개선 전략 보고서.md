## 1. 개요

본 보고서는 현재 문토 서비스의 Database 및 주요 쿼리의 구조적 문제를 진단하고, 이에 따른 기술적/비즈니스적 부작용과 근본 원인을 분석한 뒤, 실현 가능한 개선 전략을 제시하기 위한 목적에서 작성되었습니다.

---

## 2. 현재 문제 요약

다음은 실제 운영 중인 주요 테이블 및 쿼리에 대한 분석 결과입니다:

### 주요 발견 사항

- 단건 조회에도 `findMany` 사용 → IN/OFFSET 포함된 불필요한 복잡한 쿼리 생성
- `skip: 0`으로 인해 `OFFSET 0`이 항상 포함됨 → 실행 계획에 불필요한 영향
- pagination 시 `OFFSET` 방식만 사용 → 사용자 수 증가 시 성능 급락
- 단일 값 조건에 `in: [value]` 사용 → index 활용 저하
- `SELECT *` 사용 빈번 → 불필요한 I/O 증가
- 인덱스가 없는 필드로 조회 → Full Scan 자주 발생
- Fat Table 구조 (`User`, `Socialing`, 등) → 모든 요청이 대용량 테이블에 종속
- 대량 IN 조건 (1000개 이상) → PostgreSQL 최적화 불가, 처리 시간 수 초
- COUNT + JOIN + NOT IN 조합 → 느리고 확장성 없는 쿼리

---

## 3. 발생할 수 있는 부작용

- **성능 저하의 선형 증가**: 쿼리 복잡도가 O(n)에 가까워 **사용자 수가 10배 증가하면 현재 2초 걸리는 쿼리는 20초가 소요될 수 있습니다.** 이는 실사용이 불가능한 상태로 직결되며, 결국 시스템 전체의 병목으로 이어집니다.
- **확장 불가능한 구조**: 테이블에 기능이 집중되어 scale-out이 어려움
- **Redis 캐시 의존 심화**: 느린 쿼리를 보완하기 위해 캐시가 과도하게 사용됨 → 캐시 미스 시 장애 발생. 특히 Redis 비용이 전체 RDS의 약 50%에 육박할 정도로 과중하며, 이는 구조적 문제로 인해 발생한 불필요한 비용으로 판단됨. 또한 캐시 사용으로 인해 실시간 데이터 반영이 어려워지고, 사용자 행동에 대한 즉각적 반응이 불가능한 문제가 발생함 (예: 팔로우/언팔로우, 라이크 상태 변경 등). 이는 UX 저하와 데이터 불일치 리스크를 동시에 유발함.
- **시스템 비용 증가**: 비효율적 쿼리로 인해 RDS 및 Redis 비용이 지속적으로 증가하고 있음. 또한, ECS Fargate의 과도한 리소스 사용으로 인해 전체 인프라 비용이 비정상적으로 상승 중임.
- **서비스 품질 저하**: **평균 응답 시간이 수 초를 넘으면 사용자 이탈 가속화**
- **기술 부채 고착화**: 시간이 지날수록 리팩토링 비용이 기하급수적으로 증가

---

## 4. 이런 문제가 발생한 원인

### 1) 개발자의 무지

- SQL 기본 원리와 인덱스, ORM 쿼리 생성 방식에 대한 이해 부족
- 단건 조회에 `findMany`, 조건 없이 `SELECT *` 등 비효율적 사용

### 2) 개발자의 무관심과 무책임

- 성능을 고려하지 않고 "일단 되게 만들자"는 접근
- 잘못된 코드가 반복되어도 수정하지 않음

### 3) 리뷰 및 품질 관리 부재

- 쿼리 성능 기준, 스키마 설계 기준이 없음
- 백엔드 구조보다는 프론트 결과 중심으로 개발/리뷰 진행

### 4) 초기 설계 미흡

- 도메인 분리 없이 단일 테이블에 무한히 필드 추가
- 읽기/쓰기 목적이 혼재된 구조 (CQRS 분리 없음)

### 5) 기술 부채에 대한 조직의 무감각

- 기술 부채가 명확함에도 리스크 회피로 인해 방치
- 시간이 지날수록 구조가 점점 더 개선 불가능한 방향으로 고착화

---

## 5. 개선 전략

### 단기 (즉시 적용 가능)

| 항목                 | 개선 방안                                                          |
| -------------------- | ------------------------------------------------------------------ |
| 단건 조회            | `findUnique`, `findFirst` 사용                                     |
| 불필요한 OFFSET 제거 | `skip: 0` 제거, `OFFSET` 생략                                      |
| `SELECT *` 제거      | 명시적 필드 지정 (`select`)                                        |
| 단일 조건            | `in: [value]` → `=` 로 변환                                        |
| COUNT 최적화         | `JOIN + NOT IN` → `JOIN + NOT EXISTS` 또는 `LEFT JOIN` + `IS NULL` |
| 대량 IN 쿼리         | chunking 또는 temp table + JOIN 방식 전환                          |

### 중기 (구조 개선 중심)

| 항목           | 개선 방안                                                        |
| -------------- | ---------------------------------------------------------------- |
| Pagination     | OFFSET → Cursor 기반 pagination 적용                             |
| 조회 성능      | 자주 조회하는 조건에 복합 인덱스 추가 (예: `status + startDate`) |
| 조회 전용 View | 조회용 `user_projection`, `feed_summary` 등 경량 뷰 테이블 도입  |
| ORM 통일       | 공통 include/select 전략 정의 및 재사용                          |

### 장기 (근본적 구조 개선)

| 항목                | 개선 방안                                                                                          |
| ------------------- | -------------------------------------------------------------------------------------------------- |
| Fat Table 분리      | `User` 등 핵심 테이블을 도메인별 서브 테이블로 분할 (`UserProfile`, `UserStatus`, `UserSocial` 등) |
| CQRS 분리           | 읽기/쓰기 모델 분리 설계 적용                                                                      |
| 기술 부채 관리 체계 | 정기적인 쿼리 점검 및 구조 리뷰 도입                                                               |

---

## 6. 결론

현재 문토의 데이터베이스와 쿼리 구조는 단기적으로는 성능 저하를, 중장기적으로는 서비스 확장의 한계를 초래합니다. 이미 평균 쿼리 응답 시간이 수 초에 달하는 경우도 존재하며, 이는 사용자 수 증가 시 **선형적으로 악화**될 수밖에 없는 구조입니다.

이는 **“성공을 감당할 수 없는 시스템 구조”**입니다. 지금이 바로, 가장 적은 비용으로 구조를 고칠 수 있는 마지막 기회입니다.

기술 부채는 미루면 미룰수록 비용이 기하급수적으로 증가합니다. 계획적이고 단계적인 리팩토링 전략 수립과 실행이 절실합니다.
